"use strict";

var CMark = require("commonmark");
var VNode = require("virtual-dom/vnode/vnode");
var VText = require("virtual-dom/vnode/vtext");

exports.parseAST = function (markdown) {
  var reader = new CMark.Parser();
  var parsed = reader.parse(markdown);
  var walker = parsed.walker();

  var stack = [];
  var event = undefined;
  while (event = walker.next()) {
    var node = event.node;
    if (!event.entering) {
      // TODO props
      var children = stack.shift();
      var current = new VNode(node.type, {}, children);
      if (stack.length) {
        stack[0].push(current);
      } else {
        return current;
      }
    } else if (node.isContainer()) {
      stack.unshift([]);
    } else if (node.type === "Text") {
      var text = new VText(node.literal);
      stack[0].push(text);
    } else if (node.type === "CodeBlock") {
      var lines = node.literal.split("\n");
      lines.pop();
      lines = lines.map(function (line) {
        return new VText(line + "\n");
      });
      var code = new VNode(node.type, {}, lines);
      stack[0].push(code);
    } else {
      // TODO props
      // TODO literal inside it
      var leaf = new VNode(node.type, {});
      stack[0].push(leaf);
    }
  }

  throw new Error("Oops, can't create AST. It shouldn't happen...");
};
"use strict";

var vdiff = require("virtual-dom/diff");

exports.diff = vdiff;
"use strict";

var shapes = {
  document: "note",
  block: "box",
  inline: "oval" };


var solarizedLight = {
  back: "#fdf6e3",
  fill: "#eee8d5",
  font: "#073642",
  strg: "#586e75",
  edge: "#002b36",
  code: "#268bd2" };

var solarizedDark = {
  back: "#002b36",
  fill: "#073642",
  font: "#fdf6e3",
  strg: "#eee8d5",
  edge: "#93a1a1",
  code: "#2aa198" };

exports.palettes = { solarizedLight: solarizedLight, solarizedDark: solarizedDark };


var defaults = {
  palette: solarizedLight,
  fontsize: 14,
  fontname: "Inconsolata" };


exports.exportDot = function (ast, filename) {
  var options = arguments[2] === undefined ? {} : arguments[2];
  var pal = options.palette || defaults.palette;
  var size = options.fontsize || defaults.fontsize;
  var font = options.fontname || defaults.fontname;

  var out = ["digraph \"" + filename + "\" {", "graph [rankdir=\"LR\", bgcolor=\"" + pal.back + "\"];", "node [style=\"filled\", fontcolor=\"" + pal.font + "\", fillcolor=\"" + pal.fill + "\", color=\"" + pal.edge + "\", fontsize=" + size + ", fontname=\"" + font + "\"];", "edge [color=\"" + pal.edge + "\"];"];
  var n = 0;

  var builder = function (items, parent) {
    var ids = [];
    for (var _iterator = items[Symbol.iterator](), _step; !(_step = _iterator.next()).done;) {
      var item = _step.value;
      var id = n++;
      var children = [];
      var shape = shapes.inline;
      var label = item.tagName;
      var more = "";
      if (item.children) {
        children = builder(item.children, item.tagName);
        shape = shapes.block;
      }
      if (item.tagName === "Document") {
        shape = shapes.document;
      } else if (parent === "CodeBlock" || parent === "Code") {
        label = item.text;
        more = ", fontcolor=\"" + pal.code + "\"";
      } else if (item.type === "VirtualText") {
        label = "'" + item.text + "'";
        more = ", fontcolor=\"" + pal.strg + "\"";
      } else if (item.tagName === "Link" || item.tagName === "Image") {
        more = ", href=\"" + item.properties.href + "\"";
      }
      label = label.replace(/["\\]/g, "\\$&");
      out.push("  n" + id + " [label=\"" + label + "\", shape=\"" + shape + "\"" + more + "];");
      for (var _iterator2 = children[Symbol.iterator](), _step2; !(_step2 = _iterator2.next()).done;) {
        var child = _step2.value;
        out.push("  n" + id + " -> n" + child + ";");
      }
      ids.push(id);
    }
    return ids;
  };

  builder([ast]);
  out.push("}");
  return out.join("\n");
};
"use strict";

exports.toMarkdown = function (ast) {
  var buffer = "";
  var out = function (s) {
    return buffer += s;
  };
  var tag = function (node, before, after) {
    out(before);
    for (var _iterator = node.children[Symbol.iterator](), _step; !(_step = _iterator.next()).done;) {
      var child = _step.value;
      walk(child);
    }
    out(after);
  };

  var walk = function (node) {
    switch (node.tagName) {
      case "Document":
        tag(node, "", "");
        break;
      case "HtmlBlock":
      case "Paragraph":
      case "List":
        tag(node, "", "\n\n");
        break;
      case "Item":
        tag(node, "* ", "");
        break;
      case "Header":
        tag(node, "# ", " #\n\n");
        break;
      case "Blockquote":
        tag(node, "> ", "\n\n");
        break;
      case "CodeBlock":
        tag(node, "\n```\n", "\n```\n\n");
        break;
      case "Html":
        out(node.literal);
        break;
      case "Softbreak":
        out("\n");
        break;
      case "Hardbreak":
        out("  \n");
        break;
      case "Image":
        tag(node, "![", "](" + node.href + ")");
        break;
      case "Link":
        tag(node, "[", "](" + node.href + ")");
        break;
      case "Code":
        tag(node, "`", "`");
        break;
      case "Emph":
        tag(node, "_", "_");
        break;
      case "Strong":
        tag(node, "**", "**");
        break;
      case "HorizontalRule":
        out("\n----\n");
        break;
      case undefined:
        out(node.text);
        break;
      default:
        throw new Error("Unknown node in AST: " + node.tagName);
    }
  };

  walk(ast);
  return buffer;
};
"use strict";

var fs = require("fs");

exports.readStdinOrFile = function (filename) {
  return new Promise(function (resolve, reject) {
    if (filename === "-") {
      (function () {
        var chunks = [];
        process.stdin.setEncoding("utf8");
        process.stdin.on("readable", function () {
          var chunk = process.stdin.read();
          if (chunk !== null) {
            chunks.push(chunk);
          }
        });
        process.stdin.on("end", function () {
          resolve(chunks.join(""));
        });
      })();
    } else {
      fs.readFile(filename, { encoding: "utf8" }, function (err, data) {
        if (err) {
          return reject("Error on reading " + filename + ": " + err);
        }
        resolve(data);
      });
    }
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzdC5qcyIsImRpZmYuanMiLCJkb3QuanMiLCJ0b19tYXJrZG93bi5qcyIsInV0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3BDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ2pELElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDOztBQUVqRCxPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVMsUUFBUSxFQUFFO0FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ2xDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDOztBQUUvQixNQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7QUFDZixNQUFJLEtBQUssWUFBQSxDQUFDO0FBQ1YsU0FBUSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFHO0FBQzlCLFFBQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7QUFDeEIsUUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7O0FBRW5CLFVBQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUMvQixVQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUNuRCxVQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7QUFDaEIsYUFBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztPQUN4QixNQUFNO0FBQ0wsZUFBTyxPQUFPLENBQUM7T0FDaEI7S0FDRixNQUFNLElBQUksSUFBSSxDQUFDLFdB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LEVBQUUsQ0FBQztBQUNuQyxjQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7QUFDbEIsa0JBQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7V0FDcEI7U0FDRixDQUFDLENBQUM7QUFDSCxlQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsWUFBVztBQUNqQyxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMxQixDQUFDLENBQUM7O0tBQ0osTUFBTTtBQUNMLFFBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFFLFVBQVMsR0FBRyxFQUFFLElBQUksRUFBRTtBQUM5RCxZQUFJLEdBQUcsRUFBRTtBQUNQLGlCQUFPLE1BQU0sdUJBQXNCLFFBQVEsVUFBTyxHQUFHLENBQUksQ0FBQztTQUMzRDtBQUNELGVBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztPQUNmLENBQUMsQ0FBQztLQUNKO0dBRUYsQ0FBQyxDQUFDO0NBQ0osQ0FBQyIsImZpbGUiOiJtZGRpZmYuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBDTWFyayA9IHJlcXVpcmUoXCJjb21tb25tYXJrXCIpO1xuY29uc3QgVk5vZGUgPSByZXF1aXJlKFwidmlydHVhbC1kb20vdm5vZGUvdm5vZGVcIik7XG5jb25zdCBWVGV4dCA9IHJlcXVpcmUoXCJ2aXJ0dWFsLWRvbS92bm9kZS92dGV4dFwiKTtcblxuZXhwb3J0cy5wYXJzZUFTVCA9IGZ1bmN0aW9uKG1hcmtkb3duKSB7XG4gIGNvbnN0IHJlYWRlciA9IG5ldyBDTWFyay5QYXJzZXIoKTtcbiAgY29uc3QgcGFyc2VkID0gcmVhZGVyLnBhcnNlKG1hcmtkb3duKTtcbiAgY29uc3Qgd2Fsa2VyID0gcGFyc2VkLndhbGtlcigpO1xuXG4gIGxldCBzdGFjayA9IFtdO1xuICBsZXQgZXZlbnQ7XG4gIHdoaWxlICgoZXZlbnQgPSB3YWxrZXIubmV4dCgpKSkge1xuICAgIGNvbnN0IG5vZGUgPSBldmVudC5ub2RlO1xuICAgIGlmICghZXZlbnQuZW50ZXJpbmcpIHtcbiAgICAgIC8vIFRPRE8gcHJvcHNcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gc3RhY2suc2hpZnQoKTtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSBuZXcgVk5vZGUobm9kZS50eXBlLCB7fSwgY2hpbGRyZW4pO1xuICAgICAgaWYgKHN0YWNrLmxlbmd0aCkge1xuICAgICAgICBzdGFja1swXS5wdXNoKGN1cnJlbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChub2RlLmlzQ29udGFpbmVyKCkpIHtcbiAgICAgIHN0YWNrLnVuc2hpZnQoW10pO1xuICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAnVGV4dCcpIHtcbiAgICAgIGNvbnN0IHRleHQgPSBuZXcgVlRleHQobm9kZS5saXRlcmFsKTtcbiAgICAgIHN0YWNrWzBdLnB1c2godGV4dCk7XG4gICAgfSBlbHNlIGlmIChub2RlLnR5cGUgPT09ICdDb2RlQmxvY2snKSB7XG4gICAgICBsZXQgbGluZXMgPSBub2RlLmxpdGVyYWwuc3BsaXQoJ1xcbicpO1xuICAgICAgbGluZXMucG9wKCk7XG4gICAgICBsaW5lcyA9IGxpbmVzLm1hcCgobGluZSkgPT4gbmV3IFZUZXh0KGxpbmUgKyAnXFxuJykpO1xuICAgICAgY29uc3QgY29kZSA9IG5ldyBWTm9kZShub2RlLnR5cGUsIHt9LCBsaW5lcyk7XG4gICAgICBzdGFja1swXS5wdXNoKGNvZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUT0RPIHByb3BzXG4gICAgICAvLyBUT0RPIGxpdGVyYWwgaW5zaWRlIGl0XG4gICAgICBjb25zdCBsZWFmID0gbmV3IFZOb2RlKG5vZGUudHlwZSwge30pO1xuICAgICAgc3RhY2tbMF0ucHVzaChsZWFmKTtcbiAgICB9XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoXCJPb3BzLCBjYW4ndCBjcmVhdGUgQVNULiBJdCBzaG91bGRuJ3QgaGFwcGVuLi4uXCIpO1xufTtcbiIsImNvbnN0IHZkaWZmID0gcmVxdWlyZShcInZpcnR1YWwtZG9tL2RpZmZcIik7XG5cbmV4cG9ydHMuZGlmZiA9IHZkaWZmO1xuIiwiY29uc3Qgc2hhcGVzID0ge1xuICBkb2N1bWVudDogXCJub3RlXCIsXG4gIGJsb2NrOiBcImJveFwiLFxuICBpbmxpbmU6IFwib3ZhbFwiLFxufTtcblxuXG5jb25zdCBzb2xhcml6ZWRMaWdodCA9IHtcbiAgYmFjazogXCIjZmRmNmUzXCIsXG4gIGZpbGw6IFwiI2VlZThkNVwiLFxuICBmb250OiBcIiMwNzM2NDJcIixcbiAgc3RyZzogXCIjNTg2ZTc1XCIsXG4gIGVkZ2U6IFwiIzAwMmIzNlwiLFxuICBjb2RlOiBcIiMyNjhiZDJcIixcbn07XG5cbmNvbnN0IHNvbGFyaXplZERhcmsgPSB7XG4gIGJhY2s6IFwiIzAwMmIzNlwiLFxuICBmaWxsOiBcIiMwNzM2NDJcIixcbiAgZm9udDogXCIjZmRmNmUzXCIsXG4gIHN0cmc6IFwiI2VlZThkNVwiLFxuICBlZGdlOiBcIiM5M2ExYTFcIixcbiAgY29kZTogXCIjMmFhMTk4XCIsXG59O1xuXG5leHBvcnRzLnBhbGV0dGVzID0geyBzb2xhcml6ZWRMaWdodCwgc29sYXJpemVkRGFyayB9O1xuXG5cbmNvbnN0IGRlZmF1bHRzID0ge1xuICBwYWxldHRlOiBzb2xhcml6ZWRMaWdodCxcbiAgZm9udHNpemU6IDE0LFxuICBmb250bmFtZTogXCJJbmNvbnNvbGF0YVwiLFxufTtcblxuXG5leHBvcnRzLmV4cG9ydERvdCA9IGZ1bmN0aW9uKGFzdCwgZmlsZW5hbWUsIG9wdGlvbnM9e30pIHtcbiAgY29uc3QgcGFsICA9IG9wdGlvbnMucGFsZXR0ZSAgfHwgZGVmYXVsdHMucGFsZXR0ZTtcbiAgY29uc3Qgc2l6ZSA9IG9wdGlvbnMuZm9udHNpemUgfHwgZGVmYXVsdHMuZm9udHNpemU7XG4gIGNvbnN0IGZvbnQgPSBvcHRpb25zLmZvbnRuYW1lIHx8IGRlZmF1bHRzLmZvbnRuYW1lO1xuXG4gIGxldCBvdXQgPSBbYGRpZ3JhcGggXCIkeyBmaWxlbmFtZSB9XCIge2AsXG4gICAgICAgICAgICAgYGdyYXBoIFtyYW5rZGlyPVwiTFJcIiwgYmdjb2xvcj1cIiR7IHBhbC5iYWNrIH1cIl07YCxcbiAgICAgICAgICAgICBgbm9kZSBbc3R5bGU9XCJmaWxsZWRcIiwgZm9udGNvbG9yPVwiJHsgcGFsLmZvbnQgfVwiLCBmaWxsY29sb3I9XCIkeyBwYWwuZmlsbCB9XCIsIGNvbG9yPVwiJHsgcGFsLmVkZ2UgfVwiLCBmb250c2l6ZT0keyBzaXplIH0sIGZvbnRuYW1lPVwiJHsgZm9udCB9XCJdO2AsXG4gICAgICAgICAgICAgYGVkZ2UgW2NvbG9yPVwiJHsgcGFsLmVkZ2UgfVwiXTtgXG4gICAgICAgICAgICBdO1xuICBsZXQgbiA9IDA7XG5cbiAgdmFyIGJ1aWxkZXIgPSBmdW5jdGlvbihpdGVtcywgcGFyZW50KSB7XG4gICAgbGV0IGlkcyA9IFtdO1xuICAgIGZvciAobGV0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICAgIGxldCBpZCA9IG4rKztcbiAgICAgIGxldCBjaGlsZHJlbiA9IFtdO1xuICAgICAgbGV0IHNoYXBlID0gc2hhcGVzLmlubGluZTtcbiAgICAgIGxldCBsYWJlbCA9IGl0ZW0udGFnTmFtZTtcbiAgICAgIGxldCBtb3JlID0gXCJcIjtcbiAgICAgIGlmIChpdGVtLmNoaWxkcmVuKSB7XG4gICAgICAgIGNoaWxkcmVuID0gYnVpbGRlcihpdGVtLmNoaWxkcmVuLCBpdGVtLnRhZ05hbWUpO1xuICAgICAgICBzaGFwZSA9IHNoYXBlcy5ibG9jaztcbiAgICAgIH1cbiAgICAgIGlmIChpdGVtLnRhZ05hbWUgPT09IFwiRG9jdW1lbnRcIikge1xuICAgICAgICBzaGFwZSA9IHNoYXBlcy5kb2N1bWVudDtcbiAgICAgIH0gZWxzZSBpZiAocGFyZW50ID09PSBcIkNvZGVCbG9ja1wiIHx8IHBhcmVudCA9PT0gXCJDb2RlXCIpIHtcbiAgICAgICAgbGFiZWwgPSBpdGVtLnRleHQ7XG4gICAgICAgIG1vcmUgPSBgLCBmb250Y29sb3I9XCIkeyBwYWwuY29kZSB9XCJgO1xuICAgICAgfSBlbHNlIGlmIChpdGVtLnR5cGUgPT09IFwiVmlydHVhbFRleHRcIikge1xuICAgICAgICBsYWJlbCA9IGAnJHsgaXRlbS50ZXh0IH0nYDtcbiAgICAgICAgbW9yZSA9IGAsIGZvbnRjb2xvcj1cIiR7IHBhbC5zdHJnIH1cImA7XG4gICAgICB9IGVsc2UgaWYgKGl0ZW0udGFnTmFtZSA9PT0gXCJMaW5rXCIgfHwgaXRlbS50YWdOYW1lID09PSBcIkltYWdlXCIpIHtcbiAgICAgICAgbW9yZSA9IGAsIGhyZWY9XCIkeyBpdGVtLnByb3BlcnRpZXMuaHJlZiB9XCJgO1xuICAgICAgfVxuICAgICAgbGFiZWwgPSBsYWJlbC5yZXBsYWNlKC9bXCJcXFxcXS9nLCBcIlxcXFwkJlwiKTtcbiAgICAgIG91dC5wdXNoKGAgIG4keyBpZCB9IFtsYWJlbD1cIiR7IGxhYmVsIH1cIiwgc2hhcGU9XCIkeyBzaGFwZSB9XCIkeyBtb3JlIH1dO2ApO1xuICAgICAgZm9yIChsZXQgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgb3V0LnB1c2goYCAgbiR7IGlkIH0gLT4gbiR7IGNoaWxkIH07YCk7XG4gICAgICB9XG4gICAgICBpZHMucHVzaChpZCk7XG4gICAgfVxuICAgIHJldHVybiBpZHM7XG4gIH07XG5cbiAgYnVpbGRlcihbYXN0XSk7XG4gIG91dC5wdXNoKCd9Jyk7XG4gIHJldHVybiBvdXQuam9pbihcIlxcblwiKTtcbn07XG4iLCJleHBvcnRzLnRvTWFya2Rvd24gPSBmdW5jdGlvbihhc3QpIHtcbiAgbGV0IGJ1ZmZlciA9IFwiXCI7XG4gIGxldCBvdXQgPSAocykgPT4gYnVmZmVyICs9IHM7XG4gIGxldCB0YWcgPSAobm9kZSwgYmVmb3JlLCBhZnRlcikgPT4ge1xuICAgIG91dChiZWZvcmUpO1xuICAgIGZvciAobGV0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHsgd2FsayhjaGlsZCk7IH1cbiAgICBvdXQoYWZ0ZXIpO1xuICB9O1xuXG4gIGxldCB3YWxrID0gKG5vZGUpID0+IHtcbiAgICBzd2l0Y2ggKG5vZGUudGFnTmFtZSkge1xuICAgICAgY2FzZSAnRG9jdW1lbnQnOlxuICAgICAgICB0YWcobm9kZSwgJycsICcnKTtcbiAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnSHRtbEJsb2NrJzpcbiAgICAgIGNhc2UgJ1BhcmFncmFwaCc6XG4gICAgICBjYXNlICdMaXN0JzpcbiAgICAgICAgdGFnKG5vZGUsICcnLCAnXFxuXFxuJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnSXRlbSc6XG4gICAgICAgIHRhZyhub2RlLCAnKiAnLCAnJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnSGVhZGVyJzpcbiAgICAgICAgdGFnKG5vZGUsICcjICcsICcgI1xcblxcbicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0Jsb2NrcXVvdGUnOlxuICAgICAgICB0YWcobm9kZSwgJz4gJywgJ1xcblxcbicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0NvZGVCbG9jayc6XG4gICAgICAgIHRhZyhub2RlLCAnXFxuYGBgXFxuJywgJ1xcbmBgYFxcblxcbicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0h0bWwnOlxuICAgICAgICBvdXQobm9kZS5saXRlcmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdTb2Z0YnJlYWsnOlxuICAgICAgICBvdXQoJ1xcbicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0hhcmRicmVhayc6XG4gICAgICAgIG91dCgnICBcXG4nKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdJbWFnZSc6XG4gICAgICAgIHRhZyhub2RlLCBgIVtgLCBgXSgkeyBub2RlLmhyZWYgfSlgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdMaW5rJzpcbiAgICAgICAgdGFnKG5vZGUsIGBbYCwgYF0oJHsgbm9kZS5ocmVmIH0pYCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQ29kZSc6XG4gICAgICAgIHRhZyhub2RlLCAnYCcsICdgJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnRW1waCc6XG4gICAgICAgIHRhZyhub2RlLCAnXycsICdfJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnU3Ryb25nJzpcbiAgICAgICAgdGFnKG5vZGUsICcqKicsICcqKicpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0hvcml6b250YWxSdWxlJzpcbiAgICAgICAgb3V0KCdcXG4tLS0tXFxuJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB1bmRlZmluZWQ6XG4gICAgICAgIG91dChub2RlLnRleHQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBub2RlIGluIEFTVDogJHsgbm9kZS50YWdOYW1lIH1gKTtcbiAgICB9XG4gIH07XG5cbiAgd2Fsayhhc3QpO1xuICByZXR1cm4gYnVmZmVyO1xufTtcbiIsImNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG5leHBvcnRzLnJlYWRTdGRpbk9yRmlsZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuICAgIGlmIChmaWxlbmFtZSA9PT0gXCItXCIpIHtcbiAgICAgIGxldCBjaHVua3MgPSBbXTtcbiAgICAgIHByb2Nlc3Muc3RkaW4uc2V0RW5jb2RpbmcoXCJ1dGY4XCIpO1xuICAgICAgcHJvY2Vzcy5zdGRpbi5vbihcInJlYWRhYmxlXCIsIGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zdCBjaHVuayA9IHByb2Nlc3Muc3RkaW4ucmVhZCgpO1xuICAgICAgICBpZiAoY2h1bmsgIT09IG51bGwpIHtcbiAgICAgICAgICBjaHVua3MucHVzaChjaHVuayk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcHJvY2Vzcy5zdGRpbi5vbihcImVuZFwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVzb2x2ZShjaHVua3Muam9pbihcIlwiKSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZnMucmVhZEZpbGUoZmlsZW5hbWUsIHsgZW5jb2Rpbmc6IFwidXRmOFwiIH0sIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChgRXJyb3Igb24gcmVhZGluZyAkeyBmaWxlbmFtZSB9OiAkeyBlcnIgfWApO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgfSk7XG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9